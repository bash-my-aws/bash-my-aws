#!/bin/bash
#
# vpc-functions


pcxs(){

  # List VPC Peering connections

  local filters=$(__bma_read_filters $@)
  aws ec2 describe-vpc-peering-connections                     \
    --query 'VpcPeeringConnections[].[
      [VpcPeeringConnectionId,
      Status.Code,
      join(`:`, [
        RequesterVpcInfo.OwnerId,
        RequesterVpcInfo.Region,
        RequesterVpcInfo.VpcId]
      ),
      join(`:`, [
        AccepterVpcInfo.OwnerId,
        AccepterVpcInfo.Region,
        AccepterVpcInfo.VpcId]
      ),
      join(`,`, [Tags[?Key==`Name`].Value || `NO_NAME`][])

    ]]' \
     --output text      |
  grep -E -- "$filters" |
  LC_ALL=C sort -k 5    |
  column -s$'\t' -t
}


subnets(){

  # List subnets for all VPCs
  #
  #     $ subnets
  #     subnet-34fd9cfa  vpc-018d9739  ap-southeast-2c  172.31.32.0/20  NO_NAME
  #     subnet-8bb774fe  vpc-018d9739  ap-southeast-2a  172.31.0.0/20   NO_NAME
  #     subnet-9eea2c07  vpc-018d9739  ap-southeast-2b  172.31.16.0/20  NO_NAME

  local filters=$(__bma_read_filters $@)
  local subnet_ids=$(__bma_read_inputs)

  aws ec2 describe-subnets                                       \
    $([[ -n ${subnet_ids} ]] && echo --subnet-ids ${subnet_ids}) \
    --output text                                                \
    --query "Subnets[].[
      SubnetId,
      VpcId,
      AvailabilityZone,
      CidrBlock,
      join(',', [Tags[?Key=='Name'].Value || 'NO_NAME'][])
    ]"                  |
  grep -E -- "$filters" |
  LC_ALL=C sort -k 5    |
  column -s$'\t' -t
}


vpcs() {

  # List VPCs
  #
  #     $ vpcs
  #     vpc-018d9739  default-vpc  NO_NAME  172.31.0.0/16  NO_STACK  NO_VERSION

  local vpc_ids="$(__bma_read_inputs)"
  local filters=$(__bma_read_filters $@)

  aws ec2 describe-vpcs                                                 \
    $([[ -n ${vpc_ids} ]] && echo --vpc-ids ${vpc_ids})                 \
    --output text                                                       \
    --query 'Vpcs[].[
      VpcId,
      ((IsDefault==`false`)&&`not-default`)||`default-vpc`,
      join(`,`, [Tags[?Key==`Name`].Value || `NO_NAME`][]),
      CidrBlock,
      join(`,`, [Tags[?Key==`aws:cloudformation:stack-name`].Value || `NO_STACK`][]),
      join(`,`, [Tags[?Key==`version`].Value || `NO_VERSION`][])
    ]'                  |
  grep -E -- "$filters" |
  column -s$'\t' -t
}


vpc-azs() {

  # List availability zones of VPC(s)
  #
  #     USAGE: vpc-azs vpc-id [vpc-id]
  #
  #     $ vpcs | vpc-azs
  #     vpc-018d9739 ap-southeast-2a ap-southeast-2b ap-southeast-2c

  local vpc_ids="$(__bma_read_inputs $@)"
  [[ -z "$vpc_ids" ]] && __bma_usage "vpc-id [vpc-id]" && return 1

  local vpc_id
  for vpc_id in $vpc_ids; do
    echo -n "$vpc_id "
    echo "$vpc_id" | vpc-subnets | awk '{print $3}' | LC_ALL=C sort -u | tr "\n" ' '
    echo
  done
}


vpc-az-count() {

  # List number of Availability Zones of VPC(s)
  #
  #     USAGE: vpc-az-count vpc-id [vpc-id]
  #
  #     $ vpcs | vpc-az-count
  #     vpc-018d9739 3

  local vpc_ids="$(__bma_read_inputs $@)"
  [[ -z "$vpc_ids" ]] && __bma_usage "vpc-id [vpc-id]" && return 1

  local vpc_id
  for vpc_id in $vpc_ids; do
    echo "$vpc_id $(( $(vpc-azs $vpc_id | wc -w) - 1 ))"
  done
}


vpc-lambda-functions(){

  # List lambda functions of VPC(s)
  #
  #     USAGE: vpc-lambda-functions vpc-id [vpc-id]

  local vpc_ids="$(__bma_read_inputs $@)"
  [[ -z "$vpc_ids" ]] && __bma_usage "vpc-id [vpc-id]" && return 1

  local vpc_id
  for vpc_id in $vpc_ids; do
    aws lambda list-functions                           \
      --output text                                     \
      --query "Functions[?VpcConfig.VpcId=='$vpc_id'].[
        VpcConfig.VpcId,
        FunctionName
      ]"
  done | column -s$'\t' -t
}


vpc-dhcp-options-ntp(){

  # List NTP servers of VPC(s)
  #
  #     USAGE: vpc-dhcp-options-ntp vpc-id [vpc-id]

  aws ec2 describe-dhcp-options                                              \
    --output text                                                            \
    --query "
      DhcpOptions[].DhcpConfigurations[?Key=='ntp-servers'].Values[][].Value
    "
}


vpc-endpoints(){

  # List VPC Endpoints of VPC(s)
  #
  #     USAGE: vpc-endpoints vpc-id [vpc-id]

  local vpc_ids="$(__bma_read_inputs)"
  local filters=$(__bma_read_filters $@ $vpc_ids)

  aws ec2 describe-vpc-endpoints \
  --output text                  \
  --query '
    VpcEndpoints[].[
      VpcEndpointId,
      VpcId,
      State,
      VpcEndpointType,
      ServiceName
    ]'                  |
  grep -E -- "$filters" |
  sort -k 5             |
  column -s$'\t' -t
}


vpc-endpoint-services(){

  # List available VPC endpoint services
  #
  #     USAGE: vpc-endpoint-services vpc-id [vpc-id]

  local filters=$(__bma_read_filters $@)

  aws ec2 describe-vpc-endpoint-services     \
  --output text                              \
  --query "
    ServiceDetails[].[
      ServiceName,
      join(',', ServiceType[].ServiceType)
    ]"                  |
  grep -E -- "$filters" |
  column -s$'\t' -t     |
  sort
}


vpc-igw() {

  # List Internet Gateway of VPC(s)
  #
  #     USAGE: vpc-igw vpc-id [vpc-id]

  local vpc_ids="$(__bma_read_inputs $@)"
  [[ -z "$vpc_ids" ]] && __bma_usage "vpc-id [vpc-id]" && return 1

  local vpc_id
  for vpc_id in $vpc_ids; do
    aws ec2 describe-internet-gateways                                       \
      --output text                                                          \
      --query "InternetGateways[?contains(Attachments[].VpcId, '$vpc_id')].[
        InternetGatewayId,
        join(',', Attachments[].VpcId)
      ]"
  done | column -s$'\t' -t
}


vpc-route-tables(){

  # List Route Tables of VPC(s)
  #
  #     USAGE: vpc-route-tables vpc-id [vpc-id]
  #
  #     $ vpcs | vpc-route-tables
  #     rtb-8e841c39  vpc-018d9739  NO_NAME

  local vpc_ids="$(__bma_read_inputs $@)"
  [[ -z "$vpc_ids" ]] && __bma_usage "vpc-id [vpc-id]" && return 1

  local vpc_id
  for vpc_id in $vpc_ids; do
    aws ec2 describe-route-tables                             \
      --output text                                           \
      --query "RouteTables[?VpcId=='$vpc_id'].[
        RouteTableId,
        VpcId,
        join(',', [Tags[?Key=='Name'].Value || 'NO_NAME'][])
      ]"              |
    column -s$'\t' -t
  done
}


vpc-nat-gateways(){

  # List NAT Gateways of VPC(s)
  #
  #     USAGE: vpc-nat-gateways vpc-id [vpc-id]

  local vpc_ids="$(__bma_read_inputs $@)"
  [[ -z "$vpc_ids" ]] && __bma_usage "vpc-id [vpc-id]" && return 1

  local vpc_id
  for vpc_id in $vpc_ids; do
    aws ec2 describe-nat-gateways                 \
      --output text                               \
      --query "NatGateways[?VpcId=='$vpc_id'].[
        NatGatewayId,
        VpcId,
        join(',', NatGatewayAddresses[].PublicIp)
      ]"
  done              |
  column -s$'\t' -t
}


vpc-subnets(){

  # List subnets of VPC(s)
  #
  #     USAGE: vpc-subnets vpc-id [vpc-id]
  #
  #     $ vpcs | vpc-subnets
  #     subnet-34fd9cfa  vpc-018d9739  ap-southeast-2c  172.31.32.0/20  NO_NAME
  #     subnet-8bb774fe  vpc-018d9739  ap-southeast-2a  172.31.0.0/20   NO_NAME
  #     subnet-9eea2c07  vpc-018d9739  ap-southeast-2b  172.31.16.0/20  NO_NAME

  local vpc_ids="$(__bma_read_inputs $@)"
  [[ -z "$vpc_ids" ]] && __bma_usage "vpc-id [vpc-id]" && return 1

  local vpc_id
  for vpc_id in $vpc_ids; do
    aws ec2 describe-subnets                            \
      --output text                                     \
      --query "Subnets[?VpcId=='$vpc_id'].[ SubnetId ]"
  done | subnets
}


vpc-network-acls(){

  # List Network ACLs of VPC(s)
  #
  #     USAGE: vpc-network-acls vpc-id [vpc-id]
  #
  #     $ vpcs | vpc-network-acls
  #     acl-ff4914d1  vpc-018d9739

  local vpc_ids="$(__bma_read_inputs $@)"
  [[ -z "$vpc_ids" ]] && __bma_usage "vpc-id [vpc-id]" && return 1

  local vpc_id
  for vpc_id in $vpc_ids; do
    aws ec2 describe-network-acls                                    \
      --output text                                                  \
      --query "NetworkAcls[?VpcId=='$vpc_id'].[NetworkAclId, VpcId]"
  done | column -s$'\t' -t
}


vpc-rds(){

  # List RDS instances of VPC(s)
  #
  #     USAGE: vpc-rds vpc-id [vpc-id]

  local vpc_ids="$(__bma_read_inputs $@)"
  [[ -z "$vpc_ids" ]] && __bma_usage "vpc-id [vpc-id]" && return 1

  local vpc_id
  for vpc_id in $vpc_ids; do
    aws rds describe-db-instances                               \
      --output text                                             \
      --query "DBInstances[?DBSubnetGroup.VpcId=='${vpc_id}'].[
        DBInstanceIdentifier,
        DBSubnetGroup.VpcId,
        DBName
      ]"
  done | column -s$'\t' -t
}


vpc-default-delete() {

  # Print commands you would need to run to delete that pesky default VPC
  # Exclude default VPCs that contain:
  # - instances
  # - lambda functions
  #
  #     $ vpc-default-delete
  #
  #     # Deleting default VPC vpc-018d9739 in ap-southeast-2
  #     aws --region ap-southeast-2 ec2 delete-subnet --subnet-id=subnet-8bb774fe
  #     aws --region ap-southeast-2 ec2 delete-subnet --subnet-id=subnet-9eea2c07
  #     aws --region ap-southeast-2 ec2 delete-subnet --subnet-id=subnet-34fd9cfa
  #     aws --region ap-southeast-2 ec2 delete-vpc --vpc-id=vpc-018d9739

  local REGION=$AWS_DEFAULT_REGION
  local VPCID SUBNETS IGW IG INSTANCES

  local abort=false

  local VPCID=$(aws ec2 describe-vpcs --query "Vpcs[?IsDefault].VpcId" --output text)
  if [ "$VPCID" ] ; then

    # abort if instances exist in this VPC
    INSTANCES=$(aws ec2 describe-instances --query "Reservations[].Instances[?VpcId=='$VPCID'].InstanceId" --output text)
    if [ "$INSTANCES" ]; then
      echo "# $VPCID has instances:" $INSTANCES
      abort=true
    fi

    # abort if a lambda function exists in this vpc
    local LAMBDA_FUNCTIONS=$(vpc-lambda-functions $VPCID)
    if [ "$LAMBDA_FUNCTIONS" ]; then
      echo "# $VPCID has lambda functions:" $LAMBDA_FUNCTIONS
      abort=true
    fi

    # abort if an RDS instance exists in this vpc
    local RDS_INSTANCES=$(vpc-rds $VPCID)
    if [ "$RDS_INSTANCES" ]; then
      echo "# $VPCID has RDS instances:" $RDS_INSTANCES
      abort=true
    fi

    [[ "${abort}" != "false"  ]] && echo "# $VPCID skipped" && return 1

    echo "# Deleting default VPC $VPCID in $REGION"
    local SUBNETS="$(aws ec2 describe-subnets --query "Subnets[?VpcId=='$VPCID'].SubnetId" --output text)"
    if [ "$SUBNETS" ] ; then
      for SUBNET in $SUBNETS ; do
        echo aws --region $REGION ec2 delete-subnet --subnet-id=$SUBNET
      done
    fi

    # Internet Gateway - must detach and delete
    IGW=$(aws ec2 describe-internet-gateways --query "InternetGateways[?contains(Attachments[].VpcId, '$VPCID')].InternetGatewayId" --output text)
    if [ "$IGW" ] ; then
      for IG in $IGW ; do
        echo aws --region $REGION ec2 detach-internet-gateway --vpc-id $VPCID --internet-gateway-id $IG
        echo aws --region $REGION ec2 delete-internet-gateway --internet-gateway-id $IG
      done
    fi

    # And finally the VPC
    echo aws --region $REGION ec2 delete-vpc --vpc-id=$VPCID
  fi
}
